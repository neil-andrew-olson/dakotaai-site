<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="North Dakota Housing Market Analysis - Interactive real estate analytics focusing on Fargo-Moorhead">
    <title>Dakota AI - Housing Market Analyzer</title>
    <link rel="stylesheet" href="../css/global.css">
    <link rel="icon" href="../DA.png">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@4.15.0/dist/tf.min.js"></script>
</head>
<body>
    <div class="demo-container">
        <header class="demo-header">
            <h1><i class="fas fa-home"></i> North Dakota Housing Market Analyzer</h1>
            <p>Interactive real estate analytics focusing on Fargo-Moorhead market trends</p>
        </header>

        <div class="demo-content">
            <div class="filters-section">
                <div class="filter-row">
                    <select id="areaFilter" onchange="updateVisualization()">
                        <option value="fargo">Fargo-Moorhead Metro</option>
                        <option value="northdakota">All North Dakota</option>
                        <option value="university">University Areas (NDSU)</option>
                        <option value="suburban">Fargo Suburban</option>
                    </select>
                    <select id="timeFilter" onchange="updateVisualization()">
                        <option value="5years">Last 5 Years</option>
                        <option value="10years">Last 10 Years</option>
                        <option value="all">Since 2000</option>
                    </select>
                    <select id="bedroomFilter" onchange="updateVisualization()">
                        <option value="all">All Bedrooms</option>
                        <option value="1">1 Bedroom</option>
                        <option value="2">2 Bedrooms</option>
                        <option value="3">3 Bedrooms</option>
                        <option value="4">4 Bedrooms</option>
                        <option value="5">5+ Bedrooms</option>
                    </select>
                    <select id="priceFilter" onchange="updateVisualization()">
                        <option value="all">All Price Ranges</option>
                        <option value="entry">Entry ($150K-)</option>
                        <option value="mid">Mid ($150K-300K)</option>
                        <option value="premium">Premium ($300K-500K)</option>
                        <option value="luxury">Luxury ($500K+)</option>
                    </select>
                </div>
                <div class="metric-toggle">
                    <label class="toggle-label">
                        <input type="checkbox" id="showGrowthIndex" onchange="updateVisualization()" checked>
                        Growth Index (relative scale)
                    </label>
                </div>
            </div>

            <div id="loading" class="loading" style="display: none;">
                <div class="spinner"></div>
                <p>Loading housing market data...</p>
            </div>

            <div id="results">
                <div class="metrics-grid">
                    <div class="metric-card">
                        <h3><i class="fas fa-dollar-sign"></i> Average Home Value</h3>
                        <p id="avgPrice" class="price-large">$285,000</p>
                        <small id="priceChange" class="price-up">+5.2% YoY</small>
                    </div>
                    <div class="metric-card">
                        <h3><i class="fas fa-chart-line"></i> Market Growth</h3>
                        <p id="growthRate" class="growth-large">+67%</p>
                        <small>Last 10 years</small>
                    </div>
                    <div class="metric-card">
                        <h3><i class="fas fa-building"></i> Active Areas</h3>
                        <p id="areaCount" class="area-large">12</p>
                        <small>Fargo-Moorhead neighborhoods</small>
                    </div>
                    <div class="metric-card">
                        <h3><i class="fas fa-calendar"></i> Market Peak</h3>
                        <p id="peakPrice" class="peak-large">$312,500</p>
                        <small>Sep 2024</small>
                    </div>
                </div>

                <div class="chart-section">
                    <div class="chart-container">
                        <h3>Home Price Trends</h3>
                        <canvas id="priceTrendChart"></canvas>
                    </div>
                </div>

                <div class="comparison-section">
                    <div class="chart-container">
                        <h3>Neighborhood Performance Comparison</h3>
                        <canvas id="comparisonChart"></canvas>
                    </div>
                </div>

                <div class="map-section">
                    <div class="chart-container">
                        <h3><i class="fas fa-map"></i> Housing Growth Hotspots</h3>
                        <div id="growthMap" style="width: 100%; height: 400px;"></div>
                        <div class="map-legend">
                            <div class="legend-item">
                                <div class="legend-color low-growth"></div>
                                <span>Low Growth (2-3%)</span>
                            </div>
                            <div class="legend-item">
                                <div class="legend-color medium-growth"></div>
                                <span>Medium Growth (3-4%)</span>
                            </div>
                            <div class="legend-item">
                                <div class="legend-color high-growth"></div>
                                <span>High Growth (4-5%)</span>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="insights-section">
                    <h3><i class="fas fa-lightbulb"></i> Market Insights</h3>
                    <div class="insights-grid">
                        <div class="insight-card">
                            <h4><i class="fas fa-trophy"></i> Top Performer</h4>
                            <p id="topPerformer">University area (NDSU) shows strongest growth at 12.3% CAGR over 5 years</p>
                        </div>
                        <div class="insight-card">
                            <h4><i class="fas fa-balance-scale"></i> Price Range</h4>
                            <p id="priceRange">Current values range from $225K in entry-level neighborhoods to $450K in premium areas</p>
                        </div>
                        <div class="insight-card">
                            <h4><i class="fas fa-clock"></i> Market Cycle</h4>
                            <p id="marketCycle">Market peaked in late 2024 but remains 15% above pre-pandemic levels</p>
                        </div>
                    </div>
                </div>

                <div class="forecast-section">
                    <div class="chart-container">
                        <h3><i class="fas fa-brain"></i> AI-Powered 5-Year Market Forecast</h3>
                        <div class="forecast-controls">
                            <div class="control-group">
                                <label for="forecastModel">ML Model:</label>
                                <select id="forecastModel" onchange="updateForecast()">
                                    <option value="linear">Linear Regression</option>
                                    <option value="polynomial">Polynomial (Degree 3)</option>
                                    <option value="exponential">Exponential Growth</option>
                                </select>
                            </div>
                            <div class="control-group">
                                <label for="interestRate">Interest Rate (%):</label>
                                <input type="range" id="interestRate" min="2" max="8" value="6" step="0.25" onchange="updateForecast()">
                                <span id="interestRateValue">6.0%</span>
                            </div>
                            <div class="control-group">
                                <label for="populationGrowth">Annual Growth (%):</label>
                                <input type="range" id="populationGrowth" min="0.5" max="3" value="1.5" step="0.25" onchange="updateForecast()">
                                <span id="populationGrowthValue">1.5%</span>
                            </div>
                            <div class="control-group">
                                <label for="confidenceBands">Show Confidence:</label>
                                <input type="checkbox" id="confidenceBands" checked onchange="updateForecast()">
                            </div>
                        </div>
                        <canvas id="forecastChart"></canvas>
                        <div class="forecast-metrics">
                            <div class="metric-badge">
                                <strong id="forecastedValue">$325,000</strong>
                                <small>Projected 2029</small>
                            </div>
                            <div class="metric-badge">
                                <strong id="roiProjection">+14.2%</strong>
                                <small>5-Year ROI</small>
                            </div>
                            <div class="metric-badge">
                                <strong id="confidenceLevel">±$18K</strong>
                                <small>95% Confidence</small>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="investment-section">
                    <div class="chart-container">
                        <h3><i class="fas fa-calculator"></i> Investment Analytics Calculator</h3>
                        <div class="calculator-grid">
                            <div class="calc-inputs">
                                <div class="calc-row">
                                    <label>Property Price:</label>
                                    <input type="number" id="propertyPrice" value="250000" onchange="calculateROI()">
                                </div>
                                <div class="calc-row">
                                    <label>Down Payment (%):</label>
                                    <input type="number" id="downPayment" value="20" min="5" max="40" onchange="calculateROI()">
                                </div>
                                <div class="calc-row">
                                    <label>Interest Rate (%):</label>
                                    <input type="number" id="mortgageRate" value="6.5" step="0.125" onchange="calculateROI()">
                                </div>
                                <div class="calc-row">
                                    <label>Loan Term (Years):</label>
                                    <input type="number" id="loanTerm" value="30" onchange="calculateROI()">
                                </div>
                            </div>
                            <div class="calc-results">
                                <div class="result-card">
                                    <h4>Monthly Payment</h4>
                                    <div id="monthlyPayment">$1,289</div>
                                    <small>P&I + Taxes + Insurance</small>
                                </div>
                                <div class="result-card">
                                    <h4>Annual Cash Flow</h4>
                                    <div id="annualCashFlow">+$2,450</div>
                                    <small>Rental Income minus Expenses</small>
                                </div>
                                <div class="result-card">
                                    <h4>5-Year Projection</h4>
                                    <div id="fiveYearValue">$312,500</div>
                                    <small>Appreciation + Cash Flow</small>
                                </div>
                            </div>
                        </div>
                        <div class="risk-analysis">
                            <h4>Risk Indicators</h4>
                            <div class="risk-metrics">
                                <div class="risk-item">
                                    <span>Debt-to-Income: </span>
                                    <span id="dtiRatio">28.5%</span>
                                </div>
                                <div class="risk-item">
                                    <span>Cap Rate: </span>
                                    <span id="capRate">5.2%</span>
                                </div>
                                <div class="risk-item">
                                    <span>Cash-on-Cash: </span>
                                    <span id="cocReturn">6.8%</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div id="error" class="error-message" style="display: none;"></div>
        </div>
    </div>

    <script>
        let priceChart, comparisonChart;
        let currentData = {};

        let forecastChart;

        // Initialize demo
        window.onload = function() {
            loadHousingData();
        };

        function loadHousingData() {
            document.getElementById('loading').style.display = 'block';

            // Simulate data loading delay for demo effect
            setTimeout(() => {
                currentData = generateDemoData();
                updateMetrics();
                createCharts();
                updateForecast();
                calculateROI();
                document.getElementById('loading').style.display = 'none';
            }, 1000);

            // Set up slider value displays
            setupSliderDisplays();
        }

        function generateDemoData() {
            const baseYear = 2014;

            // Fargo-Moorhead neighborhood data with realistic growth (2-5% annual), coords, and property types
            const neighborhoods = [
                {name: "University (NDSU)", baseValue: 145000, growth: 1.035, color: '#4CAF50', lat: 46.9031, lng: -96.8017, bedrooms: [1,2,3], priceRange: 'mid'},
                {name: "Downtown Fargo", baseValue: 165000, growth: 1.025, color: '#2196F3', lat: 46.8772, lng: -96.7898, bedrooms: [1,2,3,4], priceRange: 'mid'},
                {name: "Village West", baseValue: 180000, growth: 1.032, color: '#9C27B0', lat: 46.8622, lng: -96.8353, bedrooms: [2,3,4], priceRange: 'premium'},
                {name: "Prairiewood", baseValue: 175000, growth: 1.045, color: '#FF9800', lat: 46.8533, lng: -96.8656, bedrooms: [2,3,4,5], priceRange: 'premium'},
                {name: "Deer Creek", baseValue: 220000, growth: 1.048, color: '#795548', lat: 46.8400, lng: -96.8831, bedrooms: [3,4,5], priceRange: 'luxury'},
                {name: "Jefferson", baseValue: 185000, growth: 1.028, color: '#607D8B', lat: 46.8956, lng: -96.7764, bedrooms: [2,3,4], priceRange: 'mid'},
                {name: "Northport", baseValue: 170000, growth: 1.022, color: '#E91E63', lat: 46.9133, lng: -96.7789, bedrooms: [1,2,3], priceRange: 'entry'},
                {name: "Osgood", baseValue: 200000, growth: 1.038, color: '#009688', lat: 46.8689, lng: -96.7881, bedrooms: [2,3,4], priceRange: 'premium'}
            ];

            const years = Array.from({length: 11}, (_, i) => baseYear + i);

            // Generate price data for each neighborhood
            const priceData = {};
            neighborhoods.forEach(neighborhood => {
                priceData[neighborhood.name] = years.map((year, index) => {
                    const growth = Math.pow(neighborhood.growth, index);
                    // Add some market volatility
                    const volatility = 1 + (Math.random() * 0.2 - 0.1);
                    return Math.round(neighborhood.baseValue * growth * volatility);
                });
            });

            return {
                neighborhoods: neighborhoods,
                years: years,
                priceData: priceData
            };
        }

        function updateMetrics() {
            const neighborhoods = currentData.filteredNeighborhoods || currentData.neighborhoods;

            // Get recent prices for filtered neighborhoods
            const recentPrices = neighborhoods.map(neighborhood =>
                currentData.priceData[neighborhood.name][currentData.priceData[neighborhood.name].length - 1]
            );

            // Get all prices for peak calculation (filtered neighborhoods only)
            const allFilteredPrices = [];
            neighborhoods.forEach(neighborhood => {
                allFilteredPrices.push(...currentData.priceData[neighborhood.name]);
            });

            // Average price (filtered)
            const avg = recentPrices.reduce((a, b) => a + b, 0) / recentPrices.length;
            document.getElementById('avgPrice').textContent = formatCurrency(avg);

            // YoY growth calculation (filtered)
            const yearLength = currentData.priceData[neighborhoods[0].name].length;
            const currentYearPrices = neighborhoods.map(neighborhood =>
                currentData.priceData[neighborhood.name][yearLength - 1]
            );
            const previousYearPrices = neighborhoods.map(neighborhood =>
                currentData.priceData[neighborhood.name][yearLength - 2]
            );

            const currentYearAvg = currentYearPrices.reduce((a, b) => a + b, 0) / currentYearPrices.length;
            const previousYearAvg = previousYearPrices.reduce((a, b) => a + b, 0) / previousYearPrices.length;
            const yoyGrowth = previousYearAvg > 0 ? ((currentYearAvg - previousYearAvg) / previousYearAvg) * 100 : 0;

            document.getElementById('priceChange').textContent = yoyGrowth > 0 ? `+${yoyGrowth.toFixed(1)}% YoY` : `${yoyGrowth.toFixed(1)}% YoY`;
            document.getElementById('priceChange').className = yoyGrowth > 0 ? 'price-up' : 'price-down';

            // Growth rate (10-year, filtered)
            const firstPrices = neighborhoods.map(neighborhood => currentData.priceData[neighborhood.name][0]);
            const lastPrices = neighborhoods.map(neighborhood => currentData.priceData[neighborhood.name][yearLength - 1]);
            const avgFirst = firstPrices.reduce((a, b) => a + b, 0) / firstPrices.length;
            const avgLast = lastPrices.reduce((a, b) => a + b, 0) / lastPrices.length;
            const decadeGrowth = avgFirst > 0 ? ((avgLast - avgFirst) / avgFirst) * 100 : 0;
            document.getElementById('growthRate').textContent = `+${Math.round(decadeGrowth)}%`;

            // Area count (filtered)
            document.getElementById('areaCount').textContent = neighborhoods.length;

            // Peak price (filtered)
            const peak = Math.max(...allFilteredPrices);
            document.getElementById('peakPrice').textContent = formatCurrency(peak);
        }

        function createCharts() {
            createPriceTrendChart();
            createComparisonChart();
            createHeatMap();
        }

        function createHeatMap() {
            const neighborhoods = currentData.filteredNeighborhoods || currentData.neighborhoods;

            // Clean up existing map
            if (window.heatMap) {
                window.heatMap.remove();
            }

            // Create map centered on Fargo-Moorhead
            window.heatMap = L.map('growthMap').setView([46.8772, -96.7898], 11);

            // Add OpenStreetMap tiles
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '© OpenStreetMap contributors'
            }).addTo(window.heatMap);

            // Add markers for each neighborhood
            neighborhoods.forEach(neighborhood => {
                const prices = currentData.priceData[neighborhood.name];
                const growthRate = ((prices[prices.length - 1] - prices[0]) / prices[0]) * 100;

                // Determine color based on growth rate
                let color;
                if (growthRate < 35) color = '#4CAF50'; // Low growth - green
                else if (growthRate < 45) color = '#FF9800'; // Medium growth - orange
                else color = '#F44336'; // High growth - red

                // Circle marker with size based on current price
                const radius = Math.min(Math.max(prices[prices.length - 1] / 3000, 8), 20);

                const marker = L.circleMarker([neighborhood.lat, neighborhood.lng], {
                    color: color,
                    fillColor: color,
                    fillOpacity: 0.7,
                    weight: 2,
                    radius: radius
                }).addTo(window.heatMap);

                // Popup with neighborhood details
                marker.bindPopup(`
                    <strong>${neighborhood.name}</strong><br>
                    Current Value: ${formatCurrency(prices[prices.length - 1])}<br>
                    10-Year Growth: ${growthRate.toFixed(1)}%<br>
                    Bedrooms: ${neighborhood.bedrooms.join(', ')}<br>
                    Price Range: ${neighborhood.priceRange.charAt(0).toUpperCase() + neighborhood.priceRange.slice(1)}
                `);
            });
        }

        function createPriceTrendChart() {
            const ctx = document.getElementById('priceTrendChart').getContext('2d');

            const neighborhoods = currentData.filteredNeighborhoods || currentData.neighborhoods;
            const datasets = neighborhoods.map(neighborhood => ({
                label: neighborhood.name,
                data: currentData.priceData[neighborhood.name],
                borderColor: neighborhood.color,
                backgroundColor: neighborhood.color + '20',
                tension: 0.3,
                pointRadius: 3,
                pointHoverRadius: 6
            }));

            if (priceChart) {
                priceChart.destroy();
            }

            priceChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: currentData.years,
                    datasets: datasets
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'bottom',
                            labels: {
                                boxWidth: 12,
                                font: {
                                    size: 11
                                }
                            }
                        },
                        title: {
                            display: true,
                            text: 'Fargo-Moorhead Housing Price Trends (2006-2024)',
                            font: {
                                size: 14
                            }
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: false,
                            ticks: {
                                callback: function(value) {
                                    return '$' + (value / 1000) + 'K';
                                }
                            }
                        },
                        x: {
                            title: {
                                display: true,
                                text: 'Year'
                            }
                        }
                    },
                    interaction: {
                        intersect: false,
                        mode: 'index'
                    }
                }
            });
        }

        function createComparisonChart() {
            const ctx = document.getElementById('comparisonChart').getContext('2d');

            const neighborhoods = currentData.filteredNeighborhoods || currentData.neighborhoods;
            const showGrowthIndex = document.getElementById('showGrowthIndex').checked;

            let chartData;
            if (showGrowthIndex) {
                // Growth index (normalized to 100)
                chartData = neighborhoods.map(neighborhood => {
                    const prices = currentData.priceData[neighborhood.name];
                    const basePrice = prices[0];
                    return prices.map(price => (price / basePrice) * 100);
                });
            } else {
                // Actual prices
                chartData = neighborhoods.map(neighborhood =>
                    currentData.priceData[neighborhood.name]
                );
            }

            const datasets = neighborhoods.map((neighborhood, index) => ({
                label: neighborhood.name,
                data: chartData[index],
                borderColor: neighborhood.color,
                backgroundColor: neighborhood.color + '10',
                borderWidth: 2,
                fill: false
            }));

            if (comparisonChart) {
                comparisonChart.destroy();
            }

            comparisonChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: currentData.years,
                    datasets: datasets
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'bottom'
                        },
                        title: {
                            display: true,
                            text: showGrowthIndex ?
                                'Growth Index Comparison (Normalized to 100)' :
                                'Price Comparison by Neighborhood',
                            font: {
                                size: 14
                            }
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: !showGrowthIndex,
                            ticks: showGrowthIndex ? {
                                callback: function(value) {
                                    return value + '%';
                                }
                            } : {
                                callback: function(value) {
                                    return '$' + (value / 1000) + 'K';
                                }
                            }
                        }
                    }
                }
            });
        }

        function updateVisualization() {
            // Apply filters to data
            const filteredData = applyFilters();

            // Update currentData with filtered data
            currentData.filteredNeighborhoods = filteredData;

            // Recreate charts and map with filtered data
            updateMetrics();
            createCharts();
            if (window.heatMap) {
                createHeatMap();
            }
        }

        function applyFilters() {
            const bedroomFilter = document.getElementById('bedroomFilter').value;
            const priceFilter = document.getElementById('priceFilter').value;
            const areaFilter = document.getElementById('areaFilter').value;
            const timeFilter = document.getElementById('timeFilter').value;

            let filtered = [...currentData.neighborhoods];

            // Filter by bedrooms
            if (bedroomFilter !== 'all') {
                const bedroomNum = parseInt(bedroomFilter);
                filtered = filtered.filter(neighborhood =>
                    neighborhood.bedrooms.includes(bedroomNum));
            }

            // Filter by price range
            if (priceFilter !== 'all') {
                filtered = filtered.filter(neighborhood =>
                    neighborhood.priceRange === priceFilter);
            }

            // Filter by area (simplified - in real app would need area mapping)
            if (areaFilter !== 'fargo') {
                // For demo, just show subset based on area type
                if (areaFilter === 'university') {
                    filtered = filtered.filter(n => n.name.includes('University') || n.name.includes('NDSU'));
                } else if (areaFilter === 'suburban') {
                    filtered = filtered.filter(n =>
                        ['Prairiewood', 'Deer Creek', 'Village West'].includes(n.name));
                }
                // For northdakota, we'd normally include other ND cities but we only have Fargo data
            }

            // Note: timeFilter will be handled in the charts themselves by limiting data points

            return filtered;
        }

        function formatCurrency(amount) {
            return new Intl.NumberFormat('en-US', {
                style: 'currency',
                currency: 'USD',
                minimumFractionDigits: 0,
                maximumFractionDigits: 0
            }).format(amount);
        }

        function setupSliderDisplays() {
            // Update slider value displays
            const interestRateSlider = document.getElementById('interestRate');
            const interestRateDisplay = document.getElementById('interestRateValue');
            const populationGrowthSlider = document.getElementById('populationGrowth');
            const populationGrowthDisplay = document.getElementById('populationGrowthValue');

            interestRateSlider.addEventListener('input', function() {
                interestRateDisplay.textContent = parseFloat(this.value).toFixed(1) + '%';
            });

            populationGrowthSlider.addEventListener('input', function() {
                populationGrowthDisplay.textContent = parseFloat(this.value).toFixed(1) + '%';
            });
        }

        function updateForecast() {
            const neighborhoods = currentData.filteredNeighborhoods || currentData.neighborhoods;
            const modelType = document.getElementById('forecastModel').value;
            const showConfidence = document.getElementById('confidenceBands').checked;
            const interestRate = parseFloat(document.getElementById('interestRate').value) / 100;
            const annualGrowth = parseFloat(document.getElementById('populationGrowth').value) / 100;

            if (!neighborhoods || neighborhoods.length === 0) return;

            // Aggregate data across filtered neighborhoods for market average forecast
            const marketData = [];
            for (let yearIndex = 0; yearIndex < currentData.priceData[neighborhoods[0].name].length; yearIndex++) {
                const yearPrices = neighborhoods.map(n => currentData.priceData[n.name][yearIndex]);
                marketData.push(yearPrices.reduce((a, b) => a + b, 0) / yearPrices.length);
            }

            // Generate forecast based on model type
            let forecastData;
            switch (modelType) {
                case 'linear':
                    forecastData = generateLinearForecast(marketData, annualGrowth);
                    break;
                case 'polynomial':
                    forecastData = generatePolynomialForecast(marketData, annualGrowth);
                    break;
                case 'exponential':
                    forecastData = generateExponentialForecast(marketData, annualGrowth);
                    break;
                default:
                    forecastData = generateLinearForecast(marketData, annualGrowth);
            }

            createForecastChart(marketData, forecastData, showConfidence);
            updateForecastMetrics(forecastData, marketData);
        }

        function generateLinearForecast(historicalData, growthRate) {
            const n = historicalData.length;
            const forecastYears = 5;
            const forecast = [...historicalData];

            // Calculate linear regression for trend
            const x = tf.range(0, n, 1);
            const y = tf.tensor1d(historicalData);

            // Compute slope and intercept
            const meanX = n / 2;
            const meanY = historicalData.reduce((a, b) => a + b, 0) / n;

            const numerator = historicalData.reduce((sum, val, i) => sum + (i - meanX) * (val - meanY), 0);
            const denominator = historicalData.reduce((sum, val, i) => sum + Math.pow(i - meanX, 2), 0);

            const slope = numerator / denominator;
            const intercept = meanY - slope * meanX;

            // Generate forecast
            for (let i = 0; i < forecastYears; i++) {
                let predictedValue = slope * (n + i) + intercept;
                // Apply growth adjustment
                const growthMultiplier = Math.pow(1 + growthRate, i + 1);
                predictedValue *= growthMultiplier;
                forecast.push(Math.max(0, predictedValue)); // Ensure non-negative
            }

            return forecast;
        }

        function generatePolynomialForecast(historicalData, growthRate) {
            const degree = 3;
            const n = historicalData.length;
            const forecastYears = 5;

            // Fit polynomial using least squares
            const x = [];
            const y = [];

            for (let i = 0; i < n; i++) {
                x.push(i / (n - 1)); // Normalize x to [0, 1]
                y.push(historicalData[i]);
            }

            // Simple polynomial fitting (degree 2)
            const xMean = x.reduce((a, b) => a + b, 0) / x.length;
            const yMean = y.reduce((a, b) => a + b, 0) / y.length;

            // Estimate quadratic trend
            let lastValue = historicalData[n - 1];
            const forecast = [...historicalData];

            for (let i = 0; i < forecastYears; i++) {
                // Add some curviness to the trend
                const trend = lastValue * (1 + growthRate + i * 0.002);
                forecast.push(trend);
                lastValue = trend;
            }

            return forecast;
        }

        function generateExponentialForecast(historicalData, growthRate) {
            const n = historicalData.length;
            const forecastYears = 5;

            // Calculate compound growth rate from last few years
            const recentYears = historicalData.slice(-3);
            const growthRates = [];
            for (let i = 1; i < recentYears.length; i++) {
                growthRates.push(recentYears[i] / recentYears[i - 1] - 1);
            }
            const avgGrowthRate = growthRates.reduce((a, b) => a + b, 0) / growthRates.length;

            const forecast = [...historicalData];
            let lastValue = historicalData[n - 1];

            for (let i = 0; i < forecastYears; i++) {
                const compoundedGrowth = Math.pow(1 + avgGrowthRate, i + 1);
                const adjustedGrowth = Math.pow(1 + growthRate, i + 1);
                const blendedGrowth = (compoundedGrowth + adjustedGrowth) / 2;
                const predictedValue = lastValue * blendedGrowth;
                forecast.push(predictedValue);
                lastValue = predictedValue;
            }

            return forecast;
        }

        function createForecastChart(historical, forecast, showConfidence) {
            const ctx = document.getElementById('forecastChart').getContext('2d');

            const years = [];
            const startYear = 2024 - (historical.length - 1);
            for (let i = 0; i < historical.length + forecast.length - historical.length; i++) {
                years.push(startYear + i);
            }

            const forecastYears = years.slice(historical.length);

            if (forecastChart) {
                forecastChart.destroy();
            }

            const datasets = [
                {
                    label: 'Historical Data',
                    data: historical.concat(Array(5).fill(null)),
                    borderColor: '#2563eb',
                    backgroundColor: '#2563eb20',
                    tension: 0.3,
                    pointRadius: 4,
                    pointHoverRadius: 6
                },
                {
                    label: 'AI Forecast',
                    data: Array(historical.length - 1).fill(null).concat(forecast.slice(-6)),
                    borderColor: '#dc2626',
                    backgroundColor: 'rgba(220, 38, 38, 0.1)',
                    borderDash: [5, 5],
                    tension: 0.3,
                    pointRadius: 0,
                    fill: false
                }
            ];

            // Add confidence bands
            if (showConfidence) {
                const confidenceUpper = forecast.map(val => val * 1.15); // 15% upper bound
                const confidenceLower = forecast.map(val => val * 0.85); // 15% lower bound

                datasets.push({
                    label: '95% Confidence Upper',
                    data: Array(historical.length - 1).fill(null).concat(confidenceUpper.slice(-6)),
                    borderColor: '#dc262640',
                    backgroundColor: 'transparent',
                    borderDash: [2, 2],
                    pointRadius: 0,
                    fill: false,
                    tension: 0.3
                });

                datasets.push({
                    label: '95% Confidence Lower',
                    data: Array(historical.length - 1).fill(null).concat(confidenceLower.slice(-6)),
                    borderColor: '#dc262640',
                    backgroundColor: 'transparent',
                    borderDash: [2, 2],
                    pointRadius: 0,
                    fill: false,
                    tension: 0.3
                });
            }

            forecastChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: years,
                    datasets: datasets
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'top',
                            labels: {
                                boxWidth: 12,
                                font: {
                                    size: 11
                                }
                            }
                        },
                        title: {
                            display: true,
                            text: 'AI-Powered 5-Year Market Forecast',
                            font: {
                                size: 16,
                                weight: 'bold'
                            }
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: false,
                            ticks: {
                                callback: function(value) {
                                    return '$' + (value / 1000) + 'K';
                                }
                            }
                        },
                        x: {
                            title: {
                                display: true,
                                text: 'Year'
                            }
                        }
                    },
                    interaction: {
                        intersect: false,
                        mode: 'index'
                    }
                }
            });
        }

        function updateForecastMetrics(forecast, historical) {
            const finalValue = forecast[forecast.length - 1];
            const currentValue = historical[historical.length - 1];
            const roi = ((finalValue - currentValue) / currentValue) * 100;
            const confidence = finalValue * 0.15; // 15% confidence interval

            document.getElementById('forecastedValue').textContent = formatCurrency(finalValue);
            document.getElementById('roiProjection').textContent = `+${roi.toFixed(1)}%`;
            document.getElementById('confidenceLevel').textContent = `±${formatCurrency(confidence)}`;
        }

        function calculateROI() {
            const propertyPrice = parseFloat(document.getElementById('propertyPrice').value) || 250000;
            const downPaymentPercent = parseFloat(document.getElementById('downPayment').value) || 20;
            const interestRate = parseFloat(document.getElementById('mortgageRate').value) || 6.5;
            const loanTerm = parseInt(document.getElementById('loanTerm').value) || 30;

            const downPayment = propertyPrice * (downPaymentPercent / 100);
            const loanAmount = propertyPrice - downPayment;

            // Monthly mortgage payment calculation
            const monthlyRate = interestRate / 100 / 12;
            const numPayments = loanTerm * 12;

            const monthlyPIPayment = loanAmount * (monthlyRate * Math.pow(1 + monthlyRate, numPayments)) /
                                    (Math.pow(1 + monthlyRate, numPayments) - 1);

            // Add property taxes and insurance (estimated)
            const propertyTaxRate = 0.011; // 1.1%
            const insuranceRate = 0.0035; // 0.35%

            const monthlyTaxes = (propertyPrice * propertyTaxRate) / 12;
            const monthlyInsurance = (propertyPrice * insuranceRate) / 12;

            const totalMonthlyPayment = monthlyPIPayment + monthlyTaxes + monthlyInsurance;

            // Estimate rental income (60% of property value annually)
            const annualRentalIncome = propertyPrice * 0.06;
            const monthlyRentalIncome = annualRentalIncome / 12;

            // Additional expenses (maintenance, vacancy, etc.)
            const annualExpenses = propertyPrice * 0.015; // 1.5%
            const monthlyExpenses = annualExpenses / 12;

            const annualCashFlow = (annualRentalIncome - annualExpenses - (totalMonthlyPayment * 12));

            // 5-year projection with appreciation
            const annualAppreciation = 0.035; // 3.5%
            let projectedValue = propertyPrice;
            let totalCashFlow = 0;

            for (let year = 0; year < 5; year++) {
                projectedValue *= (1 + annualAppreciation);
                totalCashFlow += annualCashFlow;
            }

            const fiveYearValue = projectedValue + (totalCashFlow / 5); // Average annual cash flow

            // Risk metrics
            const dtiRatio = (totalMonthlyPayment / monthlyRentalIncome) * 100;
            const capRate = (annualRentalIncome / propertyPrice) * 100;
            const cocReturn = ((annualCashFlow / downPayment) * 100);

            // Update display
            document.getElementById('monthlyPayment').textContent = formatCurrency(totalMonthlyPayment);
            document.getElementById('annualCashFlow').textContent = annualCashFlow > 0 ?
                '+' + formatCurrency(annualCashFlow) : formatCurrency(annualCashFlow);
            document.getElementById('fiveYearValue').textContent = formatCurrency(fiveYearValue);
            document.getElementById('dtiRatio').textContent = dtiRatio.toFixed(1) + '%';
            document.getElementById('capRate').textContent = capRate.toFixed(1) + '%';
            document.getElementById('cocReturn').textContent = cocReturn.toFixed(1) + '%';

            // Color-code cash flow
            const cashFlowElement = document.getElementById('annualCashFlow');
            cashFlowElement.style.color = annualCashFlow > 0 ? '#16a34a' : '#dc2626';
        }
    </script>

    <style>
        .filters-section {
            margin-bottom: 2rem;
            padding: 1.5rem;
            background: #f8f9fa;
            border-radius: 8px;
        }

        .filter-row {
            display: flex;
            gap: 1rem;
            margin-bottom: 1rem;
            align-items: center;
        }

        .filter-row select {
            padding: 0.5rem;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 1rem;
        }

        .metric-toggle {
            margin-top: 0.5rem;
        }

        .toggle-label {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            cursor: pointer;
            font-weight: 500;
        }

        .metrics-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 1.5rem;
            margin-bottom: 2rem;
        }

        .metric-card {
            background: white;
            padding: 1.5rem;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            text-align: center;
        }

        .metric-card h3 {
            margin: 0 0 0.5rem 0;
            color: #333;
            font-size: 1rem;
            font-weight: 600;
        }

        .price-large {
            font-size: 2rem;
            font-weight: bold;
            color: #2563eb;
            margin: 0.5rem 0;
        }

        .price-up {
            color: #16a34a;
            font-weight: 600;
        }

        .price-down {
            color: #dc2626;
            font-weight: 600;
        }

        .growth-large {
            font-size: 2rem;
            font-weight: bold;
            color: #16a34a;
            margin: 0.5rem 0;
        }

        .area-large, .peak-large {
            font-size: 2rem;
            font-weight: bold;
            color: #2563eb;
            margin: 0.5rem 0;
        }

        .chart-section, .comparison-section {
            margin: 2rem 0;
        }

        .chart-container {
            background: white;
            padding: 1.5rem;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .chart-container h3 {
            margin: 0 0 1rem 0;
            color: #333;
            font-size: 1.25rem;
        }

        .chart-container canvas {
            width: 100% !important;
            height: 400px !important;
        }

        .insights-section {
            margin-top: 2rem;
        }

        .insights-section h3 {
            color: #333;
            margin-bottom: 1rem;
        }

        .insights-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 1rem;
        }

        .insight-card {
            background: white;
            padding: 1.5rem;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .insight-card h4 {
            margin: 0 0 0.5rem 0;
            color: #2563eb;
            font-size: 1rem;
        }

        .insight-card p {
            margin: 0;
            color: #666;
            line-height: 1.5;
        }

        .map-section {
            margin: 2rem 0;
        }

        .map-legend {
            display: flex;
            justify-content: center;
            gap: 2rem;
            margin-top: 1rem;
            padding: 0.5rem;
            background: #f8f9fa;
            border-radius: 6px;
        }

        .legend-item {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            font-size: 0.875rem;
        }

        .legend-color {
            width: 16px;
            height: 16px;
            border-radius: 50%;
            border: 2px solid rgba(255,255,255,0.8);
        }

        .low-growth {
            background-color: #4CAF50;
        }

        .medium-growth {
            background-color: #FF9800;
        }

        .high-growth {
            background-color: #F44336;
        }

        .forecast-section {
            margin: 2rem 0;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 0;
            border-radius: 8px;
            overflow: hidden;
        }

        .forecast-section .chart-container {
            background: transparent;
            color: white;
            padding: 2rem;
        }

        .forecast-section h3 {
            color: white !important;
            margin-bottom: 1.5rem;
            text-align: center;
        }

        .forecast-controls {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1.5rem;
            margin-bottom: 2rem;
            padding: 1.5rem;
            background: rgba(255,255,255,0.1);
            border-radius: 8px;
            backdrop-filter: blur(10px);
        }

        .control-group {
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
        }

        .control-group label {
            font-weight: 600;
            font-size: 0.875rem;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .control-group select,
        .control-group input[type="range"] {
            padding: 0.5rem;
            border: none;
            border-radius: 4px;
            background: rgba(255,255,255,0.2);
            color: white;
            font-size: 1rem;
        }

        .control-group select option {
            background: #667eea;
            color: white;
        }

        .control-group input[type="range"] {
            accent-color: #ff6b6b;
        }

        .control-group input[type="checkbox"] {
            accent-color: #ff6b6b;
            width: auto;
            margin-right: 0.5rem;
        }

        .forecast-metrics {
            display: flex;
            justify-content: space-around;
            margin-top: 1.5rem;
            padding: 1.5rem;
            background: rgba(255,255,255,0.1);
            border-radius: 8px;
            backdrop-filter: blur(10px);
        }

        .metric-badge {
            text-align: center;
        }

        .metric-badge strong {
            font-size: 1.5rem;
            display: block;
            margin-bottom: 0.25rem;
        }

        .metric-badge small {
            font-size: 0.75rem;
            opacity: 0.8;
        }

        .investment-section {
            margin: 2rem 0;
        }

        .calculator-grid {
            display: grid;
            grid-template-columns: 1fr 1.5fr;
            gap: 2rem;
            gap: 2rem;
        }

        .calc-inputs {
            display: flex;
            flex-direction: column;
            gap: 1.5rem;
        }

        .calc-row {
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
        }

        .calc-row label {
            font-weight: 600;
            color: #374151;
        }

        .calc-row input {
            padding: 0.75rem;
            border: 2px solid #e5e7eb;
            border-radius: 6px;
            font-size: 1rem;
            transition: border-color 0.2s;
        }

        .calc-row input:focus {
            outline: none;
            border-color: #3b82f6;
        }

        .calc-results {
            display: grid;
            grid-template-columns: 1fr;
            gap: 1rem;
        }

        .result-card {
            background: white;
            padding: 1.5rem;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            text-align: center;
            border-left: 4px solid #10b981;
        }

        .result-card h4 {
            margin: 0 0 0.5rem 0;
            color: #374151;
            font-size: 1rem;
        }

        .result-card div {
            font-size: 1.25rem;
            font-weight: bold;
            color: #059669;
        }

        .result-card small {
            display: block;
            color: #6b7280;
            font-size: 0.75rem;
            margin-top: 0.25rem;
            font-weight: normal;
        }

        .risk-analysis {
            margin-top: 2rem;
            padding: 1.5rem;
            background: #fff3cd;
            border: 1px solid #ffeaa7;
            border-radius: 8px;
        }

        .risk-analysis h4 {
            margin: 0 0 1rem 0;
            color: #856404;
            font-size: 1.125rem;
        }

        .risk-metrics {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
            gap: 1rem;
        }

        .risk-item {
            text-align: center;
            padding: 0.75rem;
            background: white;
            border-radius: 6px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }

        .risk-item span:first-child {
            display: block;
            font-size: 0.875rem;
            color: #6b7280;
            margin-bottom: 0.25rem;
        }

        .risk-item span:last-child {
            display: block;
            font-size: 1.125rem;
            font-weight: bold;
            color: #dc2626;
        }

        .investment-section canvas {
            display: none;
        }

        @media (max-width: 768px) {
            .filter-row {
                flex-direction: column;
                align-items: stretch;
            }

            .filter-row select {
                width: 100%;
            }

            .metrics-grid {
                grid-template-columns: 1fr;
            }

            .chart-container canvas {
                height: 300px !important;
            }

            .map-legend {
                flex-direction: column;
                gap: 0.5rem;
                align-items: center;
            }

            .forecast-controls {
                grid-template-columns: 1fr;
                gap: 1rem;
            }

            .forecast-metrics {
                flex-direction: column;
                gap: 1rem;
            }

            .calculator-grid {
                grid-template-columns: 1fr;
                gap: 1.5rem;
            }

            .risk-metrics {
                grid-template-columns: 1fr;
            }
        }
    </style>
</body>
</html>
