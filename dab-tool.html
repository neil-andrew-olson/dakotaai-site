<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DAB Tool - Dakota AI Bridge</title>
    <style>
        /* DAB Tool Styles */
        .dab-tool {
            max-width: 800px;
            margin: 0 auto;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border-radius: 15px;
            padding: 20px;
            box-shadow: 0 8px 32px rgba(0,0,0,0.1);
            color: white;
        }

        .dab-tool-header {
            text-align: center;
            margin-bottom: 20px;
        }

        .dab-tool-header h3 {
            margin: 0 0 10px 0;
            font-size: 24px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
        }

        .dab-tool-header p {
            margin: 0;
            opacity: 0.9;
            font-size: 16px;
        }

        .connect-btn {
            background: #4CAF50;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 16px;
            margin-top: 10px;
            transition: background 0.3s ease;
        }

        .connect-btn:hover {
            background: #45a049;
        }

        .connected-status {
            display: inline-flex;
            align-items: center;
            background: rgba(255,255,255,0.2);
            padding: 8px 16px;
            border-radius: 20px;
            margin-top: 10px;
        }

        .green-dot {
            color: #4CAF50;
            font-size: 12px;
            margin-right: 8px;
        }

        /* Tabs */
        .dab-tabs {
            display: flex;
            background: rgba(255,255,255,0.1);
            border-radius: 10px;
            padding: 5px;
            margin-bottom: 20px;
            overflow-x: auto;
        }

        .tab-btn {
            flex: 1;
            background: transparent;
            border: none;
            color: white;
            padding: 12px 16px;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
            white-space: nowrap;
            min-width: 80px;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 4px;
        }

        .tab-btn:hover:not(.active) {
            background: rgba(255,255,255,0.1);
        }

        .tab-btn.active {
            background: #4CAF50;
            box-shadow: 0 2px 8px rgba(0,0,0,0.2);
        }

        .tab-icon {
            font-size: 20px;
        }

        .tab-text {
            font-size: 12px;
        }

        /* Content */
        .dab-content {
            min-height: 400px;
        }

        .wallet-tab h4,
        .bridge-tab h4,
        .portfolio-tab h4,
        .agent-tab h4 {
            margin: 0 0 20px 0;
            font-size: 20px;
            border-left: 4px solid #4CAF50;
            padding-left: 15px;
        }

        .savings-highlight {
            background: rgba(255,255,255,0.1);
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 20px;
            text-align: center;
        }

        .big-saving {
            font-size: 18px;
        }

        .big-saving strong {
            font-size: 24px;
            color: #ffd700;
        }

        .balance-display {
            background: rgba(255,255,255,0.1);
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 20px;
        }

        .balance {
            display: flex;
            justify-content: space-between;
            margin-bottom: 15px;
            font-size: 18px;
        }

        .label {
            opacity: 0.9;
        }

        .amount {
            font-weight: bold;
            color: #ffd700;
        }

        .networks {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }

        .network-btn {
            background: rgba(255,255,255,0.2);
            border: 1px solid rgba(255,255,255,0.3);
            color: white;
            padding: 8px 12px;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .network-btn:hover:not(.active) {
            background: rgba(255,255,255,0.3);
        }

        .network-btn.active {
            background: #4CAF50;
            border-color: #4CAF50;
        }

        /* Bridge Form */
        .bridge-form {
            background: rgba(255,255,255,0.1);
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 15px;
        }

        .bridge-form label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
        }

        .network-select {
            width: 100%;
            padding: 10px;
            border: none;
            border-radius: 6px;
            margin-bottom: 10px;
            background: rgba(255,255,255,0.9);
            color: #333;
        }

        .from-section,
        .to-section {
            margin-bottom: 15px;
        }

        .amount-input {
            width: calc(100% - 60px);
            padding: 10px;
            border: none;
            border-radius: 6px;
            margin-bottom: 10px;
            background: rgba(255,255,255,0.9);
            color: #333;
        }

        .token {
            background: rgba(255,255,255,0.2);
            padding: 10px;
            border-radius: 6px;
            margin-left: 10px;
            font-weight: bold;
        }

        .received-amount {
            background: rgba(255,255,255,0.1);
            padding: 10px;
            border-radius: 6px;
            margin-top: 10px;
            font-weight: bold;
            color: #ffd700;
            min-height: 20px;
        }

        .bridge-btn {
            background: linear-gradient(45deg, #667eea, #764ba2);
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 16px;
            margin-top: 10px;
            transition: all 0.3s ease;
            width: 100%;
        }

        .bridge-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.4);
        }

        .fee-estimate {
            text-align: center;
            margin-top: 15px;
        }

        .fee-estimate small {
            opacity: 0.8;
            color: #ffd700;
        }

        /* Portfolio Cards */
        .portfolio-cards {
            display: grid;
            gap: 15px;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        }

        .portfolio-card {
            background: rgba(255,255,255,0.1);
            padding: 20px;
            border-radius: 10px;
            text-align: center;
            transition: all 0.3s ease;
        }

        .portfolio-card:hover {
            background: rgba(255,255,255,0.2);
        }

        .card-title {
            font-size: 14px;
            opacity: 0.9;
            margin-bottom: 10px;
        }

        .card-value {
            font-size: 24px;
            font-weight: bold;
            color: #ffd700;
            margin-bottom: 5px;
        }

        .card-change {
            font-size: 12px;
            color: #4CAF50;
            font-weight: bold;
        }

        .card-change.positive {
            color: #4CAF50;
        }

        /* AI Agent */
        .agent-status {
            background: rgba(255,255,255,0.1);
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 20px;
            text-align: center;
            font-weight: bold;
        }

        .agent-indicator {
            color: #4CAF50;
            font-size: 16px;
        }

        .agent-actions {
            display: grid;
            gap: 10px;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
        }

        .agent-btn {
            background: rgba(255,255,255,0.2);
            color: white;
            border: 1px solid rgba(255,255,255,0.3);
            padding: 12px 16px;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
            text-align: center;
        }

        .agent-btn:hover {
            background: rgba(255,255,255,0.3);
        }

        .agent-results {
            background: rgba(255,255,255,0.1);
            padding: 15px;
            border-radius: 10px;
            margin-top: 15px;
            text-align: center;
            color: #ffd700;
        }

        .dab-footer {
            text-align: center;
            margin-top: 20px;
            opacity: 0.8;
        }

        .dab-footer small {
            display: block;
            margin-bottom: 5px;
        }

        .dab-footer a {
            color: #ffd700;
            text-decoration: none;
        }

        .dab-footer a:hover {
            text-decoration: underline;
        }

        .arrow {
            text-align: center;
            font-size: 24px;
            margin: 10px 0;
        }

        /* Exchange Styles */
        .exchange-tab h4 {
            text-align: center;
            color: #ffd700;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
        }

        .exchange-form {
            background: rgba(255,255,255,0.1);
            padding: 25px;
            border-radius: 12px;
        }

        .swap-section {
            display: flex;
            flex-direction: column;
            gap: 20px;
            margin-bottom: 25px;
        }

        .token-input {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .token-input label {
            font-weight: bold;
            color: #ffd700;
            font-size: 14px;
        }

        .token-row {
            display: flex;
            gap: 15px;
            align-items: center;
        }

        .token-select {
            flex: 1;
            padding: 12px;
            border: none;
            border-radius: 8px;
            background: rgba(255,255,255,0.95);
            color: #333;
            font-weight: 500;
            min-width: 120px;
        }

        .swap-amount-input {
            flex: 1;
            padding: 12px;
            border: none;
            border-radius: 8px;
            background: rgba(255,255,255,0.95);
            color: #333;
            font-size: 16px;
            font-weight: 500;
        }

        .swap-arrow {
            display: flex;
            justify-content: center;
            align-items: center;
            margin: 15px 0;
        }

        .swap-button {
            background: rgba(255,255,255,0.2);
            border: 2px solid rgba(255,255,255,0.4);
            color: white;
            width: 50px;
            height: 50px;
            border-radius: 50%;
            cursor: pointer;
            font-size: 24px;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s ease;
        }

        .swap-button:hover {
            background: rgba(255,255,255,0.3);
            border-color: #ffd700;
            transform: scale(1.1);
        }

        .exchange-info {
            background: rgba(255,255,255,0.1);
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 20px;
            display: grid;
            gap: 15px;
        }

        .rate-display, .fee-display, .discount-display {
            text-align: center;
            font-weight: 500;
        }

        .rate-display {
            font-size: 18px;
            color: #ffd700;
        }

        .fee-display {
            color: #4CAF50;
        }

        .discount-display {
            color: #667eea;
            font-style: italic;
        }

        .exchange-route {
            margin: 20px 0;
        }

        .route-info {
            text-align: center;
            background: rgba(102, 126, 234, 0.2);
            padding: 10px;
            border-radius: 8px;
            font-weight: 500;
        }

        .swap-btn {
            background: linear-gradient(45deg, #667eea, #764ba2);
            color: white;
            border: none;
            padding: 15px 30px;
            border-radius: 12px;
            cursor: pointer;
            font-size: 16px;
            font-weight: bold;
            width: 100%;
            margin-bottom: 15px;
            transition: all 0.3s ease;
        }

        .swap-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.5);
        }

        .slippage-settings {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 10px;
            margin-top: 20px;
            font-size: 14px;
            color: rgba(255, 255, 255, 0.8);
        }

        .slippage-settings label {
            font-weight: 500;
        }

        .slippage-settings select {
            padding: 5px 10px;
            border: 1px solid rgba(255,255,255,0.3);
            border-radius: 4px;
            background: rgba(255,255,255,0.1);
            color: white;
        }

        @media (max-width: 768px) {
            .token-row {
                flex-direction: column;
                gap: 10px;
            }

            .swap-section {
                gap: 15px;
            }

            .exchange-info {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="dab-tool">
        <div class="dab-tool-header">
            <h3>DAB Tool - Dakota AI Bridge</h3>
            <p>AI-Powered DeFi Cross-Chain Wallet</p>

            <button class="connect-btn" onclick="connectWallet()">üîó Connect Wallet</button>
        </div>

        <div class="dab-tabs">
            <button class="tab-btn active" onclick="switchTab('wallet')">
                <span class="tab-icon">üí∞</span>
                <span class="tab-text">Wallet</span>
            </button>
            <button class="tab-btn" onclick="switchTab('exchange')">
                <span class="tab-icon">üîÑ</span>
                <span class="tab-text">Exchange</span>
            </button>
            <button class="tab-btn" onclick="switchTab('bridge')">
                <span class="tab-icon">üåâ</span>
                <span class="tab-text">Bridge</span>
            </button>
            <button class="tab-btn" onclick="switchTab('portfolio')">
                <span class="tab-icon">üìä</span>
                <span class="tab-text">Portfolio</span>
            </button>
            <button class="tab-btn" onclick="switchTab('agent')">
                <span class="tab-icon">ü§ñ</span>
                <span class="tab-text">AI Agent</span>
            </button>
        </div>

        <div id="dab-content" class="dab-content">
            <!-- Content will be populated by JavaScript -->
        </div>

        <div class="dab-footer">
            <small>Developed by Dakota AI ‚Ä¢ Monetizing DeFi with AI</small>
            <small><a href="https://dakotaai.us" target="_blank">Visit Main Site</a></small>
        </div>
    </div>

    <!-- Web3 Integration -->
    <script src="https://cdn.jsdelivr.net/npm/web3@1.7.4/dist/web3.min.js"></script>
    <script src="dab-token-config.js"></script>

    <script>
        let isConnected = false;
        let currentTab = 'wallet';
        let savings = '$1,243.89';
        let dabTokenBalance = '0.00';
        let dabTokenAddress = DAB_TOKEN_CONFIG.addresses.mainnet.mint;
        let userTier = 'Bronze';

        // Initialize
        document.addEventListener('DOMContentLoaded', function() {
            updateContent();
            checkConnection();
        });

        // Wallet Connection
        async function connectWallet() {
            if (typeof window.ethereum !== 'undefined') {
                try {
                    await window.ethereum.request({ method: 'eth_requestAccounts' });
                    isConnected = true;
                    updateUI();
                    alert('Wallet connected successfully!');
                } catch (error) {
                    console.error('User denied wallet access', error);
                    alert('Please connect your MetaMask wallet to use DAB.');
                }
            } else {
                alert('Please install MetaMask to use DAB wallet features.');
            }
        }

        async function checkConnection() {
            if (typeof window.ethereum !== 'undefined') {
                const accounts = await window.ethereum.request({ method: 'eth_accounts' });
                if (accounts.length > 0) {
                    isConnected = true;
                    updateUI();
                }
            }
        }

        // Tab Switching
        function switchTab(tabName) {
            currentTab = tabName;
            document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
            event.target.closest('.tab-btn').classList.add('active');
            updateContent();
        }

        // Update Content
        function updateContent() {
            const contentDiv = document.getElementById('dab-content');

            if (currentTab === 'wallet') {
                contentDiv.innerHTML = `
                    <div class="wallet-tab">
                        <h4>Cross-Chain Wallet</h4>
                        <div class="savings-highlight">
                            <div class="big-saving">
                                üí∏ AI Saved You: <strong>${savings}</strong> (${userTier} Tier)
                            </div>
                        </div>
                        <div class="balance-display">
                            <div class="balance">
                                <span class="label">Total Balance:</span>
                                <span class="amount">$5,242.89</span>
                            </div>
                            <div class="balance">
                                <span class="label">DAB Tokens:</span>
                                <span class="amount">${dabTokenBalance} DAB</span>
                            </div>
                            <div class="networks">
                                <button class="network-btn active">opBNB</button>
                                <button class="network-btn">BSC</button>
                                <button class="network-btn">Ethereum</button>
                                <button class="network-btn">Polygon</button>
                                <button class="network-btn dab-network">Solana</button>
                            </div>
                        </div>
                        <div style="text-align: center; margin-top: 15px;">
                            <small style="opacity: 0.8;">DAB holders get ${Math.round(DAB_TOKEN_CONFIG.getRewardMultiplier(1000) * 100)}% AI reward boost!</small>
                        </div>
                    </div>
                `;
            } else if (currentTab === 'bridge') {
                contentDiv.innerHTML = `
                    <div class="bridge-tab">
                        <h4>Smart Bridge</h4>
                        <div class="bridge-form">
                            <div class="from-section">
                                <label>From:</label>
                                <select class="network-select">
                                    <option>opBNB</option>
                                    <option>BSC</option>
                                    <option>Ethereum</option>
                                </select>
                                <input type="number" placeholder="0.00" class="amount-input" />
                                <span class="token">BNB</span>
                            </div>
                            <div class="arrow">‚ÜïÔ∏è</div>
                            <div class="to-section">
                                <label>To:</label>
                                <select class="network-select">
                                    <option>Ethereum</option>
                                    <option>BSC</option>
                                    <option>opBNB</option>
                                </select>
                                <div class="received-amount">$0.00</div>
                            </div>
                            <button class="bridge-btn" onclick="bridgeTokens()">üöÄüöÄ Bridge with AI Optimization</button>
                        </div>
                        <div class="fee-estimate">
                            <small>Fee: $0.005 (0.1%) | Savings: $9.45 vs competitors</small>
                        </div>
                    </div>
                `;
            } else if (currentTab === 'portfolio') {
                contentDiv.innerHTML = `
                    <div class="portfolio-tab">
                        <h4>Portfolio Analytics</h4>
                        <div class="portfolio-cards">
                            <div class="portfolio-card">
                                <div class="card-title">Total Value</div>
                                <div class="card-value">$5,242.89</div>
                                <div class="card-change positive">+5.23%</div>
                            </div>
                            <div class="portfolio-card">
                                <div class="card-title">Fee Savings</div>
                                <div class="card-value">${savings}</div>
                                <div class="card-change">Last 30 days</div>
                            </div>
                            <div class="portfolio-card">
                                <div class="card-title">Success Rate</div>
                                <div class="card-value">99.7%</div>
                                <div class="card-change positive">+0.3%</div>
                            </div>
                        </div>
                    </div>
                `;
            } else if (currentTab === 'exchange') {
                let allTokens = [];

                // Combine tokens from all networks (prioritize Solana for now)
                if (DAB_TOKEN_CONFIG.supportedTokens.solana) {
                    allTokens.push(...DAB_TOKEN_CONFIG.supportedTokens.solana);
                }

                const tokenOptionsFrom = allTokens.map(token =>
                    `<option value="${token.symbol}" data-address="${token.address}" data-logo="${token.logo}" data-decimals="${token.decimals}" data-name="${token.name}">
                        ${token.symbol} - ${token.name}
                    </option>`
                ).join('');

                const tokenOptionsTo = tokenOptionsFrom; // Same options for both

                contentDiv.innerHTML = `
                    <div class="exchange-tab">
                        <h4>üîÑ Multi-Token Exchange</h4>
                        <div class="exchange-form">
                            <div class="swap-section">
                                <div class="token-input">
                                    <label>You Pay</label>
                                    <div class="token-row">
                                        <select id="from-token" class="token-select" onchange="updateExchangePreview()">
                                            ${tokenOptionsFrom}
                                        </select>
                                        <input type="number" id="from-amount" placeholder="0.00" class="swap-amount-input" oninput="calculateExchange()" />
                                    </div>
                                </div>

                                <div class="swap-arrow">
                                    <button onclick="swapTokens()" class="swap-button">‚áÖ</button>
                                </div>

                                <div class="token-input">
                                    <label>You Receive</label>
                                    <div class="token-row">
                                        <select id="to-token" class="token-select" onchange="updateExchangePreview()">
                                            ${tokenOptionsTo}
                                        </select>
                                        <input type="number" id="to-amount" placeholder="0.00" class="swap-amount-input" readonly />
                                    </div>
                                </div>
                            </div>

                            <div class="exchange-info">
                                <div class="rate-display" id="exchange-rate">1 DAB = Loading...</div>
                                <div class="fee-display" id="exchange-fee">Fee: Loading...</div>
                                <div class="discount-display" id="ai-discount">
                                    AI Optimization: ${Math.round(DAB_TOKEN_CONFIG.getRewardMultiplier(1000) * 100)}% better rates for DAB holders
                                </div>
                            </div>

                            <div class="exchange-route" id="swap-route">
                                <div class="route-info">Route: Finding optimal path...</div>
                            </div>

                            <button class="swap-btn" onclick="executeSwap()">üöÄ Execute Swap with AI Optimization</button>

                            <div class="slippange-settings">
                                <label>Max Slippage: </label>
                                <select id="slippage-select">
                                    <option value="0.1">0.1%</option>
                                    <option value="0.3" selected>0.3%</option>
                                    <option value="0.5">0.5%</option>
                                    <option value="1.0">1.0%</option>
                                </select>
                            </div>
                        </div>
                    </div>
                `;
            } else if (currentTab === 'agent') {
                contentDiv.innerHTML = `
                    <div class="agent-tab">
                        <h4>ü§ñ DAB AI Agent</h4>
                        <p>Autonomous AI that optimizes your DeFi strategy:</p>
                        <div class="agent-status">
                            <span class="agent-indicator">‚óè</span> ACTIVE - Monitoring 23 pools
                        </div>
                        <div class="agent-actions">
                            <button class="agent-btn" onclick="startYieldFarming()">Start Yield Farming</button>
                            <button class="agent-btn" onclick="optimizePortfolio()">Optimize Portfolio</button>
                            <button class="agent-btn" onclick="monitorGas()">Monitor Gas</button>
                        </div>
                        <div class="agent-results">
                            <p>Last action: Rebalanced portfolio ‚Üí +$23.45 gained</p>
                        </div>
                    </div>
                `;
            }
        }

        function updateUI() {
            const connectBtn = document.querySelector('.connect-btn');
            if (isConnected) {
                connectBtn.style.display = 'none';
                // Add connected status
                const header = document.querySelector('.dab-tool-header');
                const connectedEl = document.createElement('div');
                connectedEl.className = 'connected-status';
                connectedEl.innerHTML = '<span class="green-dot">‚óè</span> Connected to opBNB';
                header.appendChild(connectedEl);
            }
        }

        // Bridge Functions
        function bridgeTokens() {
            if (!isConnected) {
                alert('Please connect your wallet first!');
                return;
            }
            alert('AI bridge optimization initiated. This would execute the optimal route in a live implementation.');
        }

        // Agent Functions
        function startYieldFarming() {
            alert('Yield farming optimization started. AI agent monitoring pools continuously.');
        }

        function optimizePortfolio() {
            alert('Portfolio optimization initiated. AI agent rebalancing holdings.');
        }

        function monitorGas() {
            alert('Gas monitoring activated. Real-time price tracking enabled.');
        }

// Exchange Functions & API Integration
let tokenPrices = {}; // Cache for price data
const APIS = {
    coingecko: {
        key: 'CG-htAfQpJ25kHiw7SxRNTjYNXA',
        base: 'https://api.coingecko.com/api/v3'
    },
    jupiter: {
        base: 'https://quote-api.jup.ag/v4',
        public: 'https://public.jupiterapi.com'
    },
    infura: {
        key: 'Xo2D94euczxqCaNhKkrPvbidaCck3rLr96SOYFZz+7c+uEG3kq2rpA'
    }
};

// Price cache with timestamps
let priceCache = {
    data: {},
    lastUpdate: 0,
    updateInterval: 30000 // 30 seconds
};

        function swapTokens() {
            const fromSelect = document.getElementById('from-token');
            const toSelect = document.getElementById('to-token');
            const fromAmount = document.getElementById('from-amount');
            const toAmount = document.getElementById('to-amount');

            // Swap the selections
            const tempValue = fromSelect.value;
            const tempText = fromSelect.options[fromSelect.selectedIndex].text;
            fromSelect.value = toSelect.value;
            fromSelect.options[fromSelect.selectedIndex].text = toSelect.options[toSelect.selectedIndex].text;
            toSelect.value = tempValue;
            toSelect.options[toSelect.selectedIndex].text = tempText;

            // Swap amounts
            const tempAmount = fromAmount.value;
            fromAmount.value = toAmount.value;
            toAmount.value = tempAmount;

            calculateExchange();
        }

        async function updateExchangePreview() {
            const fromToken = document.getElementById('from-token').value;
            const toToken = document.getElementById('to-token').value;

            try {
                // Update exchange rate display
                const rate = await getExchangeRate(fromToken, toToken);
                document.getElementById('exchange-rate').textContent = `1 ${fromToken} = ${rate.toFixed(6)} ${toToken}`;

                // Update fee estimate
                const fee = await calculateExchangeFee(fromToken, toToken);
                document.getElementById('exchange-fee').textContent = `Fee: ${fee}`;

                // Update route info
                document.getElementById('swap-route').innerHTML = `<div class="route-info">Route: ${fromToken} ‚Üí ${getBestDex(fromToken, toToken)} ‚Üí ${toToken}</div>`;

            } catch (error) {
                console.error('Exchange preview error:', error);
                document.getElementById('exchange-rate').textContent = 'Rate: Unable to fetch';
                document.getElementById('exchange-fee').textContent = 'Fee: Unable to calculate';
            }
        }

        async function calculateExchange() {
            const fromAmount = parseFloat(document.getElementById('from-amount').value) || 0;

            if (fromAmount > 0) {
                const fromToken = document.getElementById('from-token').value;
                const toToken = document.getElementById('to-token').value;

                try {
                    const rate = await getExchangeRate(fromToken, toToken);

                    // Apply DAB holder discount
                    const discountMultiplier = DAB_TOKEN_CONFIG.getRewardMultiplier(dabTokenBalance);
                    const finalRate = rate * discountMultiplier;

                    const toAmount = fromAmount * finalRate;
                    document.getElementById('to-amount').value = toAmount.toFixed(6);

                    updateExchangePreview();
                } catch (error) {
                    console.error('Exchange calculation error:', error);
                    document.getElementById('to-amount').value = '0.00';
                }
            } else {
                document.getElementById('to-amount').value = '0.00';
            }
        }

        async function getExchangeRate(fromToken, toToken) {
            // Check cache first
            const cacheKey = `${fromToken}/${toToken}`;
            const now = Date.now();

            if (priceCache.data[cacheKey] && (now - priceCache.lastUpdate) < priceCache.updateInterval) {
                return priceCache.data[cacheKey];
            }

            try {
                // Get token addresses
                const fromTokenData = getTokenData(fromToken);
                const toTokenData = getTokenData(toToken);

                if (fromToken === toToken) return 1;

                // For Solana tokens, try Jupiter API first for best quotes
                if (fromTokenData && toTokenData) {
                    try {
                        return await getJupiterQuote(fromTokenData.address, toTokenData.address);
                    } catch (error) {
                        console.log('Jupiter quote failed, falling back to CoinGecko');
                    }
                }

                // Fallback to CoinGecko API
                return await getCoinGeckoRate(fromToken, toToken);

            } catch (error) {
                console.error('Exchange rate error:', error);
                // Ultimate fallback to cached mock data
                return getCachedFallbackRate(fromToken, toToken);
            }
        }

        async function getJupiterQuote(fromMint, toMint, amount = 1000000) {
            const url = `${APIS.jupiter.base}/quote?inputMint=${fromMint}&outputMint=${toMint}&amount=${amount}&slippageBps=50`;

            const response = await fetch(url);
            if (!response.ok) throw new Error('Jupiter API failed');

            const data = await response.json();

            if (!data.outAmount || !data.inAmount) throw new Error('Invalid Jupiter response');

            // Return rate (outAmount / inAmount)
            const rate = parseInt(data.outAmount) / parseInt(data.inAmount);
            return rate;
        }

        async function getCoinGeckoRate(fromToken, toToken) {
            // Map token symbols to CoinGecko IDs
            const tokenIds = {
                'SOL': 'solana',
                'ETH': 'ethereum',
                'BTC': 'bitcoin',
                'USDC': 'usd-coin',
                'USDT': 'tether',
                'DAI': 'dai',
                'LINK': 'chainlink',
                'UNI': 'uniswap',
                'AAVE': 'aave',
                'BNB': 'binancecoin',
                'CAKE': 'pancakeswap-token',
                'RAY': 'raydium',
                'JUP': 'jupiter',
                'BONK': 'bonk',
                'WIF': 'dogwifhat',
                'DAB': 'solana' // fallback for DAB
            };

            const fromId = tokenIds[fromToken];
            const toId = tokenIds[toToken];

            if (!fromId || !toId) {
                throw new Error('Token not supported in CoinGecko');
            }

            // Get simple price data
            const url = `${APIS.coingecko.base}/simple/price?ids=${fromId},${toId}&vs_currencies=usd`;

            const response = await fetch(url, {
                headers: {
                    'X-CG-API-Key': APIS.coingecko.key
                }
            });

            if (!response.ok) throw new Error('CoinGecko API failed');

            const data = await response.json();

            if (!data[fromId] || !data[toId] || !data[fromId].usd || !data[toId].usd) {
                throw new Error('Invalid CoinGecko response');
            }

            // Return relative rate
            const rate = data[fromId].usd / data[toId].usd;
            return rate;
        }

        function getTokenData(symbol) {
            const networks = ['solana', 'ethereum', 'bsc'];
            for (const network of networks) {
                const tokens = DAB_TOKEN_CONFIG.supportedTokens[network];
                const token = tokens?.find(t => t.symbol === symbol);
                if (token) return token;
            }
            return null;
        }

        function getCachedFallbackRate(fromToken, toToken) {
            // Emergency fallback prices
            const fallbackPrices = {
                'DAB/SOL': 0.0001,
                'DAB/USDC': 0.001,
                'SOL/USDC': 150,
                'SOL/DAB': 10000,
                'USDC/DAB': 1000,
                'USDC/SOL': 0.00667,
                'BTC/USDC': 50000,
                'ETH/USDC': 3000,
                'BNB/USDC': 250
            };

            const pair = `${fromToken}/${toToken}`;
            if (fallbackPrices[pair]) return fallbackPrices[pair];

            const reversePair = `${toToken}/${fromToken}`;
            if (fallbackPrices[reversePair]) return 1 / fallbackPrices[reversePair];

            return 1; // Last resort
        }

        async function calculateExchangeFee(fromToken, toToken) {
            const slippage = parseFloat(document.getElementById('slippage-select').value);

            // Base Solana fee calculation
            let baseFee = 0.000005; // SOL

            // Add gas fees for complex swaps
            if (fromToken !== 'SOL' && toToken !== 'SOL') {
                baseFee += 0.00001;
            }

            // Add slippage buffer
            baseFee += baseFee * (slippage / 100);

            // Apply DAB holder discount
            const discount = DAB_TOKEN_CONFIG.exchange.dabHolderDiscounts[userTier.toLowerCase()] || 0;
            baseFee = baseFee * (1 - discount);

            return `$${baseFee.toFixed(6)} (${(discount * 100).toFixed(1)}% discount)`;
        }

        function getBestDex(fromToken, toToken) {
            // Simulate DEX selection based on pair
            const solanaPairs = ['SOL', 'USDC', 'USDT', 'RAY', 'WBTC', 'JUP', 'BONK', 'WIF'];
            const ethPairs = ['ETH', 'USDC', 'USDT', 'DAI', 'WBTC', 'LINK', 'UNI', 'AAVE'];

            if (solanaPairs.includes(fromToken) && solanaPairs.includes(toToken)) {
                return 'Raydium';
            } else if (ethPairs.includes(fromToken) || ethPairs.includes(toToken)) {
                return 'Uniswap';
            } else {
                return 'Jupiter (Aggregate)';
            }
        }

        async function executeSwap() {
            if (!isConnected) {
                alert('Please connect your wallet first!');
                return;
            }

            const fromAmount = parseFloat(document.getElementById('from-amount').value);
            const toAmount = parseFloat(document.getElementById('to-amount').value);
            const fromToken = document.getElementById('from-token').value;
            const toToken = document.getElementById('to-token').value;

            if (!fromAmount || fromAmount <= 0) {
                alert('Please enter a valid amount to swap.');
                return;
            }

            // Check if both tokens are Solana tokens (required for Jupiter)
            const fromTokenData = getTokenData(fromToken);
            const toTokenData = getTokenData(toToken);

            if (!fromTokenData || !toTokenData) {
                alert('Only Solana tokens are supported for live swaps currently.');
                return;
            }

            // Apply DAB holder discount
            const discountMultiplier = DAB_TOKEN_CONFIG.getRewardMultiplier(dabTokenBalance);
            const finalFromAmount = fromAmount * discountMultiplier;

            // Calculate amount in smallest units
            const fromAmountInSmallestUnits = Math.floor(finalFromAmount * Math.pow(10, fromTokenData.decimals));
            const slippage = parseFloat(document.getElementById('slippage-select').value);

            const confirmMsg = `Execute Live Swap on Solana?\n\nPay: ${fromAmount} ${fromToken}\nReceive: ${toAmount} ${toToken}\n\nFee: ${await calculateExchangeFee(fromToken, toToken)}\nDAB Holder Discount: ${((1 - discountMultiplier) * 100).toFixed(1)}% OFF\nSlippage: ${slippage}%\n\nThis will execute a real blockchain transaction!`;

            if (!confirm(confirmMsg)) {
                return;
            }

            try {
                // Show loading state
                const swapBtn = document.querySelector('.swap-btn');
                swapBtn.disabled = true;
                swapBtn.textContent = 'Executing Swap...';

                // Get Jupiter swap transaction
                const swapData = await getJupiterSwapTx(fromTokenData.address, toTokenData.address, fromAmountInSmallestUnits, slippage);

                // In a real implementation, you would:
                // 1. Sign the transaction with Phantom/MetaMask
                // 2. Submit to Solana network
                // 3. Monitor for confirmation

                console.log('Swap Data:', swapData);

                // For now, simulate success
                setTimeout(() => {
                    swapBtn.disabled = false;
                    swapBtn.textContent = 'üöÄ Execute Swap with AI Optimization';
                    alert(`‚úÖ Swap Successful!\n\nTransaction Hash: ${swapData.swapTransaction || 'SIMULATED_TX_HASH'}\n\nYou received approximately ${toAmount} ${toToken}\n\nView on: https://explorer.solana.com/`);
                }, 3000);

            } catch (error) {
                console.error('Swap execution failed:', error);
                const swapBtn = document.querySelector('.swap-btn');
                swapBtn.disabled = false;
                swapBtn.textContent = 'üöÄ Execute Swap with AI Optimization';
                alert(`‚ùå Swap Failed: ${error.message || 'Unknown error occurred'}`);
            }
        }

        async function getJupiterSwapTx(fromMint, toMint, amountIn, slippage = 0.5) {
            // First get quote
            const slippageBps = Math.floor(slippage * 100); // Convert percentage to basis points
            const quoteUrl = `${APIS.jupiter.base}/quote?inputMint=${fromMint}&outputMint=${toMint}&amount=${amountIn}&slippageBps=${slippageBps}`;

            const quoteResponse = await fetch(quoteUrl);
            if (!quoteResponse.ok) throw new Error('Failed to get quote from Jupiter');

            const quoteData = await quoteResponse.json();

            // Now get the swap transaction
            const swapUrl = `${APIS.jupiter.base}/swap`;
            const swapResponse = await fetch(swapUrl, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    quoteResponse: quoteData,
                    userPublicKey: '11111111111111111111111111111111', // Dummy wallet for demo (in real app, use connected wallet)
                    wrapAndUnwrapSol: true,
                })
            });

            if (!swapResponse.ok) throw new Error('Failed to get swap transaction from Jupiter');

            const swapData = await swapResponse.json();
            return swapData;
        }

        // Initialize exchange on tab switch
        function initializeExchange() {
            setTimeout(() => {
                updateExchangePreview();
                calculateExchange();
            }, 500);
        }

        // Listen for account changes
        if (typeof window.ethereum !== 'undefined') {
            window.ethereum.on('accountsChanged', function (accounts) {
                if (accounts.length === 0) {
                    isConnected = false;
                    updateUI();
                }
            });

            window.ethereum.on('chainChanged', function (chainId) {
                location.reload();
            });
        }
    </script>
</body>
</html>
